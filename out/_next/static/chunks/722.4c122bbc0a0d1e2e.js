"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[722],{2341:(e,t,n)=>{n.r(t),n.d(t,{default:()=>m});var o=n(854),l=n(6422),r=n(9250),i=n(8116),s=n(3019),a=n(5323),c=n(5770);let d=e=>{let{modelPath:t,animationIndex:n,onAnimationComplete:r,setIsTransitioning:d,transitionDuration:u=.5,play_duration:p=5,play_index:h=0,setPlayIndex:g}=e,m=(0,l.useRef)(null),[f,x]=(0,l.useState)(null),y=(0,l.useRef)(null);(0,l.useRef)(!1);let j=(0,l.useRef)(!1),w=(0,l.useRef)(null),b=(0,l.useRef)(0),_=(0,l.useRef)(0),v=(0,l.useRef)(!1);console.log("GLBModelViewer render - Animation index:",n,"Play index:",h);let{scene:C,animations:A}=(0,i.p)(t),{actions:E,names:M}=(0,a.f)(A,C);return(0,l.useEffect)(()=>{console.log("=== GLBModelViewer mounted ==="),console.log("Model path:",t),console.log("Animations found:",A.length),console.log("Animation names:",M),console.log("Actions available:",Object.keys(E||{}))},[t,A,M,E]),(0,l.useEffect)(()=>{if(console.log(h,b.current),M.length>0&&E){if(!M.includes(n)){console.warn('Animation index "'.concat(n,'" not found in model animations.'));return}console.log("Setting up animation index:",n,"Animation name:",n);let e=E[n];console.log("Retrieved action for animation:",e),e&&(w.current=e,y.current=e.getMixer(),console.log("Current action:",f?f.getClip().name:"None"),console.log("New action:",e.getClip().name),console.log("Is transitioning:",j.current),f&&!j.current&&(h!==b.current||0===h&&0===b.current)?(console.log("Fading from ".concat(f.getClip().name," to ").concat(e.getClip().name)),j.current=!0,d(!0),_.current=performance.now(),v.current=!0,e.reset(),e.setDuration(p),e.clampWhenFinished=!0,e.loop=c.aMy,e.play(),f.crossFadeTo(e,u,!1),b.current=h):!f&&(e.reset(),e.weight=1,e.clampWhenFinished=!0,e.loop=c.aMy,e.setDuration(p),e.play(),x(e),console.log("First animation started:",n),b.current=0,_.current=performance.now(),v.current=!1,g&&g(0)))}},[h,E,M,n,h]),(0,s.D)((e,t)=>{if(y.current&&y.current.update(t),v.current){let e=(performance.now()-_.current)/1e3;e>=u&&(console.log("CrossFade completed based on elapsed time:",e),v.current=!1,j.current=!1,d(!1),w.current&&(x(w.current),console.log("Transition completed to animation:",n)))}let o=0;if(f){let e=f.getClip().duration;(o=j.current&&w.current?w.current.time%e/e:f.time%e/e)>=1-u/p&&!j.current&&r&&r()}}),(0,o.jsx)("primitive",{ref:m,object:C,scale:1.15,position:[0,-1.75,0]})},u=e=>{let{modelPath:t,transitionDuration:n=1,play_duration:s=5,play_list:a=[],play_index:c=-1,setPlayIndex:u}=e,[p,h]=(0,l.useState)(""),[g,m]=(0,l.useState)(!1),f=a.length>0?a:null,{animations:x}=(0,i.p)(t),[y,j]=(0,l.useState)(c);(0,l.useEffect)(()=>{console.log("AnimationController useEffect triggered - modelPath:",t,"playList:",f,"play_index:",c),s/n<5&&console.warn("Warning: For smooth transitions, play_duration should be at least 5 times transitionDuration."),console.log(c),0===c&&(console.log("Setting initial play_now_index to play_index:",c),h(f?f[0]:x.length>0?"default":""),j(0),m(!1)),console.log("AnimationController mounted - initial animation index:",p)},[p,t,f,c,x,n,s]);let w=(0,l.useCallback)(()=>{if(console.log("=== Animation reached 80%, current index:",p," play_now_index:",y," isTransitioning:",g),!g){m(!0);let e=0;if(f&&y<f.length-1){e=y+1,u&&u(e),j(e),console.log("Next play_now_index set to:",e);let t=f?e<f.length?f[e]:f[f.length-1]:e<x.length-1?x[e].name:x[0].name;console.log("Switching to next animation index:",t,e),h(t)}else console.log("No playList or reached end of playList, looping back to start.")}},[p,t,n,g,y]);return(0,o.jsx)("div",{style:{width:"100%",height:"100%"},children:(0,o.jsxs)(r.Hl,{camera:{position:[0,0,2],fov:30},children:[(0,o.jsx)("ambientLight",{intensity:1.5}),(0,o.jsx)("directionalLight",{position:[10,10,5],intensity:1.5}),(0,o.jsx)(d,{modelPath:t,animationIndex:p,onAnimationComplete:w,setIsTransitioning:m,transitionDuration:n,play_duration:s,play_index:y})," "]})})};class p extends l.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Model loading error:",e,t)}render(){if(this.state.hasError){var e;return(0,o.jsxs)("div",{style:{color:"white",padding:"20px",textAlign:"center",height:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},children:[(0,o.jsx)("h2",{children:"模型加载失败"}),(0,o.jsx)("p",{children:"请检查模型文件路径是否正确:"}),(0,o.jsx)("code",{style:{background:"#333",padding:"10px",borderRadius:"4px"},children:null===(e=this.state.error)||void 0===e?void 0:e.message}),(0,o.jsx)("p",{children:"确保 GLB 文件在 public/models 目录中"})]})}return this.props.children}constructor(e){super(e),this.state={hasError:!1}}}class h{static preload(e){this.preloadedModels.has(e)||(i.p.preload(e),this.preloadedModels.add(e),console.log("Preloaded model:",e))}static isPreloaded(e){return this.preloadedModels.has(e)}static clear(){this.preloadedModels.clear()}}h.preloadedModels=new Set;let g=function(e){let{modelPath:t="/models/RTHK-weather-with-facial.glb",transitionDuration:n=1,play_duration:r=5,play_list:i=[],play_index:s=0,setPlayIndex:a}=e;return(0,l.useEffect)(()=>{t&&h.preload(t)},[t]),(0,o.jsx)("div",{className:"App",children:(0,o.jsx)(p,{children:(0,o.jsx)(u,{modelPath:t,transitionDuration:n,play_duration:r,play_list:i,play_index:s,setPlayIndex:a})})})};function m(e){let{ids:t,onPlayIndexChange:n}=e,[r,i]=(0,l.useState)(!1),[s,a]=(0,l.useState)(),[c,d]=(0,l.useState)(0);return(0,l.useEffect)(()=>{if(!t||0===t.length){a(["default"]);return}let e=!1;return(async()=>{i(!0);try{e||r||(console.log("ids:",t),a(t),d(0))}catch(t){console.error("AvatarClient segmentation error",t),d(0),e||a(["default"])}finally{e||i(!1)}})(),()=>{e=!0}},[t]),(0,o.jsxs)("div",{className:"w-full h-full",children:[s&&s.length>0?(0,o.jsx)(g,{play_list:s,play_index:c,setPlayIndex:e=>{d(e),n&&n(e)},play_duration:2.5,transitionDuration:.5}):(0,o.jsx)("div",{className:"w-full h-full flex items-center justify-center text-slate-500",children:(0,o.jsx)("div",{children:"No matching animations found for the sentence."})}),r?(0,o.jsx)("div",{className:"absolute top-2 right-2 p-2 bg-black/50 rounded-full",style:{pointerEvents:"none",position:"absolute",top:"50%",right:"50%"},children:(0,o.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-4 border-t-red-500 border-gray-200"})}):(0,o.jsx)(o.Fragment,{})]})}}}]);